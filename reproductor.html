<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor</title>
    <link rel="stylesheet" href="css/estilo.css">
</head>
<body>
    <div id="main-wrapper">
        <nav>
            <button id="btnVolver" class="btn-nav">⬅ Volver</button>
            <button id="btnLogOut" class="btn-nav btn-logout">Cerrar Sesión</button>
        </nav>

        <div class="container" id="app-container">
            <div class="video-wrapper">
                <div id="player"></div>
                <div class="capa-blindada"></div>
            </div>
            <div id="info-section"></div>
            <div class="controles">
                <button onclick="saltar(-10)">-10s</button>
                <button onclick="saltar(5)">+5s</button>
                <button class="btn-play" id="playBtn" onclick="togglePlay()">Pausa</button>
                <button onclick="saltar(10)">+10s</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "./firebase.js";
        import { baseDeTemas } from "./js/temas.js";
        import { doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { manejarExpulsion, globalLogout } from "./js/seguridad.js";

        const id = new URLSearchParams(window.location.search).get('id');
        const tema = baseDeTemas[id];
        const deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
        localStorage.setItem("deviceId", deviceId);

        document.getElementById("btnVolver").onclick = () => window.location.href = `lista-temas.html?cat=${tema.categoria}`;
        document.getElementById("btnLogOut").onclick = () => globalLogout(auth);

        document.getElementById("info-section").innerHTML = `<div class="info-huayno"><h2>${tema.titulo}</h2><p>${tema.artista}</p></div>`;

        // Seguridad: Sesión Única
        auth.onAuthStateChanged(async (user) => {
            if (!user) { window.location.href = "index.html"; return; }
            
            // Registrar este dispositivo como el activo
            await setDoc(doc(db, "sessions", user.uid), { deviceId }, { merge: true });

            // Escuchar cambios
            onSnapshot(doc(db, "sessions", user.uid), (snap) => {
                if (snap.exists() && snap.data().deviceId !== deviceId) {
                    manejarExpulsion(document.getElementById("main-wrapper"), auth);
                }
            });
        });

        // YouTube API
        let player;
        window.onYouTubeIframeAPIReady = () => {
            player = new YT.Player('player', {
                videoId: tema.videoId,
                playerVars: { start: tema.inicio, controls: 0, modestbranding: 1 }
            });
        };
        window.saltar = (s) => player.seekTo(player.getCurrentTime() + s);
        window.togglePlay = () => {
            const s = player.getPlayerState();
            if(s === 1) { player.pauseVideo(); playBtn.innerText="Play"; }
            else { player.playVideo(); playBtn.innerText="Pausa"; }
        };
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>