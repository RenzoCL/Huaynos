<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reproductor Pro - Huaynos üé∫</title>
    <link rel="stylesheet" href="estilos.css">
  </head>

  <body oncontextmenu="return false;">
    <nav>
      <a href="home.html" class="btn-nav">üè† Inicio</a>
      <button id="btnLogoutNav" class="btn-nav btn-logout">Cerrar Sesi√≥n</button>
    </nav>

    <div class="container">
      <div id="main-content">
        <div id="info-section"></div>
        <div class="video-wrapper">
          <div class="capa-blindada"></div>
          <div id="player"></div>
        </div>
        <div class="controles">
          <button class="btn-control btn-play" onclick="togglePlay()">‚èØÔ∏è PLAY / PAUSA</button>
          <button class="btn-control" onclick="seek(-10)">‚è™ -10 seg</button>
          <button class="btn-control" onclick="seek(10)">10 seg ‚è©</button>
          <button class="btn-control" onclick="seek(-5)">‚è™ -5 seg</button>
          <button class="btn-control" onclick="seek(5)">5 seg ‚è©</button>
          <button class="btn-control btn-full" onclick="irAlInicio()">üîÑ REINICIAR</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { auth, db } from "./firebase.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { baseDeHuaynos } from "./huaynos.js";
      import { manejarExpulsion, globalLogout } from "./seguridad.js";

      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id') || "1";
      const huayno = baseDeHuaynos[id] || baseDeHuaynos["1"];
      window.inicioActual = huayno.inicio;

      document.getElementById("info-section").innerHTML = `
        <div class="info-huayno">
          <span class="tonalidad-tag">${huayno.tonalidad}</span>
          <div style="font-size:1.3rem; font-weight:bold;">${huayno.titulo}</div>
          <div style="font-size:0.95rem; color:#bbb;">${huayno.artista}</div>
        </div>
      `;

      document.getElementById("btnLogoutNav").onclick = () => globalLogout(auth);

      let deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
      localStorage.setItem("deviceId", deviceId);

      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "index.html"; return; }
        const sessionRef = doc(db, "sessions", user.uid);
        await setDoc(sessionRef, { devices: [deviceId] }, { merge: false });

        onSnapshot(sessionRef, (snap) => {
          if (snap.metadata.hasPendingWrites) return;
          if (snap.exists() && !snap.data().devices.includes(deviceId)) {
            manejarExpulsion(document.getElementById("main-content"), auth);
          }
        });
      });

      if (huayno.videoId) {
        var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
        window.onYouTubeIframeAPIReady = () => {
          window.player = new YT.Player('player', {
            videoId: huayno.videoId,
            playerVars: { 'start': huayno.inicio, 'controls': 0, 'disablekb': 1, 'playsinline': 1 }
          });
        };
      } else {
        document.getElementById("player").innerHTML = `<div style="padding-top:20%; color:#888;">Video no disponible a√∫n üé∫</div>`;
      }
    </script>

    <script>
      function togglePlay() { if(window.player?.pauseVideo) player.getPlayerState()==1 ? player.pauseVideo() : player.playVideo(); }
      function seek(s) { if(window.player?.seekTo) player.seekTo(player.getCurrentTime()+s, true); }
      function irAlInicio() { if(window.player?.seekTo) { player.seekTo(window.inicioActual, true); player.playVideo(); } }
    </script>
  </body>
</html>