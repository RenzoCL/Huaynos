<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Huayno</title>
</head>
<body>

<h2 id="titulo">Cargando‚Ä¶</h2>
<div id="player"></div>
<p id="msg"></p>

<button id="logoutBtn" style="display:none;">Cerrar sesi√≥n</button>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, getDoc, setDoc } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const MAX_DEVICES = 1;

  // =========================
  // DEVICE ID √öNICO
  // =========================
  function getDeviceId() {
    let id = localStorage.getItem("device_id");
    if (!id) {
      id = crypto.randomUUID();
      localStorage.setItem("device_id", id);
    }
    return id;
  }

  const deviceId = getDeviceId();

  // =========================
  // LEER HUAYNO
  // =========================
  const params = new URLSearchParams(window.location.search);
  const huaynoId = params.get("id");

  if (!huaynoId) {
    document.getElementById("msg").innerText = "‚ùå Huayno no v√°lido.";
    throw new Error("Huayno sin ID");
  }

  // =========================
  // AUTH + CONTROL
  // =========================
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    try {
      const ref = doc(db, "sessions", user.uid);
      const snap = await getDoc(ref);

      let devices = {};

      if (snap.exists()) {
        devices = snap.data().devices || {};
      }

      // üö´ L√çMITE ALCANZADO
      if (!devices[deviceId] && Object.keys(devices).length >= MAX_DEVICES) {
        document.body.innerHTML = `
          <h2>üö´ Acceso bloqueado</h2>
          <p>Has alcanzado el l√≠mite de dispositivos permitidos.</p>
          <p>Cierra sesi√≥n en otro dispositivo.</p>
        `;
        return;
      }

      // Registrar o actualizar dispositivo
      devices[deviceId] = { lastSeen: Date.now() };

      await setDoc(ref, { devices }, { merge: true });

      // =========================
      // ACCESO OK
      // =========================
      document.getElementById("titulo").innerText =
        "üéµ Reproduciendo: " + huaynoId;

      document.getElementById("player").innerHTML = `
        <iframe width="300" height="200"
          src="https://www.youtube.com/embed/VIDEO_ID"
          allowfullscreen></iframe>
      `;

      document.getElementById("logoutBtn").style.display = "block";

      // =========================
      // CERRAR SESI√ìN
      // =========================
      document.getElementById("logoutBtn").onclick = async () => {
        const snap2 = await getDoc(ref);
        let devices2 = snap2.data().devices || {};

        // ‚ùå eliminar ESTE dispositivo
        delete devices2[deviceId];

        await setDoc(ref, { devices: devices2 }, { merge: true });

        await signOut(auth);
        localStorage.removeItem("device_id");

        window.location.href = "index.html";
      };

    } catch (e) {
      document.getElementById("msg").innerText =
        "‚ùå Error de conexi√≥n. Intenta nuevamente.";
      console.error(e);
    }
  });
</script>

</body>
</html>
