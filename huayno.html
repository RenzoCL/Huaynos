<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Reproductor Pro - Huaynos üé∫</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #111; color: white; margin: 0; text-align: center; user-select: none; }
    
    /* NAVEGACI√ìN */
    nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 20px; background: #1a1a1a; border-bottom: 1px solid #333;
      position: sticky; top: 0; z-index: 1000;
    }
    .btn-nav { text-decoration: none; font-weight: bold; font-size: 0.9rem; padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; color: white; background: #444; }
    .btn-logout { background: #e63946; }

    .container { max-width: 600px; margin: 20px auto; padding: 15px; box-sizing: border-box; }
    
    /* INFO HUAYNO */
    .info-huayno { background: #222; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 6px solid #e63946; text-align: left; }
    .tonalidad-tag { background: #e63946; color: white; padding: 3px 10px; border-radius: 4px; font-size: 0.8em; font-weight: bold; display: inline-block; margin-bottom: 10px; }
    
    /* REPRODUCTOR BLINDADO */
    .video-wrapper {
      position: relative;
      width: 100%;
      padding-top: 56.25%; 
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    #player {
      position: absolute;
      top: -12%; left: -2%;
      width: 104%; height: 124%;
    }

    .capa-blindada {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 20;
      background: rgba(0,0,0,0);
      cursor: default;
    }

    /* PANEL DE BOTONES */
    .controles {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 20px;
      background: #222;
      padding: 15px;
      border-radius: 12px;
    }

    .btn-control {
      background: #333; color: white; border: none; padding: 15px 5px;
      border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-control:active { background: #e63946; transform: scale(0.95); }
    .btn-play { background: #e63946; grid-column: span 2; font-size: 1.2rem; margin-bottom: 5px; }
    .btn-full { grid-column: span 2; background: #444; }

    /* INTERFAZ DE EXPULSI√ìN */
    .expulsion-card { 
      background: #1a1a1a; 
      border: 2px solid #e63946; 
      padding: 40px 20px; 
      border-radius: 20px; 
      margin-top: 50px;
      box-shadow: 0 0 30px rgba(230, 57, 70, 0.4);
    }
    .expulsion-card h3 { color: #e63946; font-size: 1.6rem; margin: 0 0 15px 0; }
    .aviso-importante { 
      background: rgba(230, 57, 70, 0.15); 
      padding: 15px; border-radius: 10px; 
      font-size: 0.95rem; color: #ffbaba;
      margin: 20px 0; border-left: 4px solid #e63946;
    }
    #segundos-restantes { transition: all 0.2s ease; display: inline-block; }
  </style>
</head>
<body oncontextmenu="return false;">

<nav>
  <a href="home.html" class="btn-nav">üè† Inicio</a>
  <button onclick="globalLogout()" class="btn-nav btn-logout">Cerrar Sesi√≥n</button>
</nav>

<div class="container">
  <div id="main-content">
    <div id="info-section"></div>

    <div class="video-wrapper">
      <div class="capa-blindada"></div>
      <div id="player"></div>
    </div>

    <div class="controles">
      <button class="btn-control btn-play" onclick="togglePlay()">‚èØÔ∏è PLAY / PAUSA</button>
      <button class="btn-control" onclick="seek(-10)">‚è™ -10 seg</button>
      <button class="btn-control" onclick="seek(10)">10 seg ‚è©</button>
      <button class="btn-control" onclick="seek(-5)">‚è™ -5 seg</button>
      <button class="btn-control" onclick="seek(5)">5 seg ‚è©</button>
      <button class="btn-control btn-full" onclick="irAlInicio()">üîÑ REINICIAR</button>
    </div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const baseDeHuaynos = {
    "1": { titulo: "Ayer la vi a mi ex - Banda Jazz Per√∫ Sunicancha", tonalidad: "La menor", videoId: "FTV-9T8b05I", inicio: 29 },
    "2": { titulo: "Brindar√© Por Ti - Banda Show La Huaranchal", tonalidad: "La menor", videoId: "JfLWXhriLik", inicio: 577 },
    "3": { titulo: "Cajamarquina - Banda Per√∫ Armonia y Clase (PAC)", tonalidad: "La menor", videoId: "zRM5JhjWxIA", inicio: 16 },
    "4": { titulo: "Cancer de Amor - Banda Show La Huaranchal", tonalidad: "La menor", videoId: "YuEvQ1O1qTU", inicio: 252 },
    "5": { titulo: "Chico Mentiroso", tonalidad: "La menor", videoId: null, inicio: 0 },
    "6": { titulo: "Chofercito Carretero", tonalidad: "La menor", videoId: "W9h5L96FnWo", inicio: 23 },
    "7": { titulo: "Collar de Lagrimas", tonalidad: "La menor", videoId: "I69F7OT1Jwg", inicio: 340 },
    "9": { titulo: "Dos Mas Por Favor", tonalidad: "La menor", videoId: "I69F7OT1Jwg", inicio: 580 },
    "10": { titulo: "En Soledad", tonalidad: "La menor", videoId: "6DF8IyenqVU", inicio: 0 },
    "11": { titulo: "Hualaycho Bandido", tonalidad: "La menor", videoId: "J8KgV4cDCvs", inicio: 19 },
    "12": { titulo: "Madre - Banda Son Per√∫", tonalidad: "La menor", videoId: "9_-Go4N2iiI", inicio: 41 },
    "13": { titulo: "Mala Tu", tonalidad: "La menor", videoId: "uigYOd4EwY4", inicio: 204 },
    "14": { titulo: "Me Marchar√©", tonalidad: "La menor", videoId: "SYQcSo02J0w", inicio: 29 },
    "15": { titulo: "Mi Barrio La Soledad", tonalidad: "La menor", videoId: "I69F7OT1Jwg", inicio: 18 },
    "17": { titulo: "No Se Puede Morir de Amor", tonalidad: "La menor", videoId: "bomfZf_7GgQ", inicio: 22 },
    "18": { titulo: "Otra Vez Me Enamor√©", tonalidad: "La menor", videoId: "PLm37Vp6G34", inicio: 70 },
    "19": { titulo: "Pocos Minutos", tonalidad: "La menor", videoId: "g54QPheDL8M", inicio: 23 },
    "20": { titulo: "Por el Chiquito", tonalidad: "La menor", videoId: "jrnCtIbc6_E", inicio: 189 }
  };

  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id') || "1";
  const huayno = baseDeHuaynos[id] || baseDeHuaynos["1"];
  window.inicioActual = huayno.inicio;

  document.getElementById("info-section").innerHTML = `
    <div class="info-huayno">
      <span class="tonalidad-tag">${huayno.tonalidad}</span>
      <div style="font-size:1.3rem; font-weight:bold;">${huayno.titulo}</div>
    </div>
  `;

  let deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
  localStorage.setItem("deviceId", deviceId);

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      localStorage.setItem("proximoHuayno", id);
      window.location.href = "index.html"; 
      return; 
    }

    const sessionRef = doc(db, "sessions", user.uid);
    await setDoc(sessionRef, { devices: [deviceId] }, { merge: false });

    onSnapshot(sessionRef, (snap) => {
      if (snap.exists() && !snap.data().devices.includes(deviceId)) {
        let cuentaRegresiva = 10;
        
        document.getElementById("main-content").innerHTML = `
          <div class="expulsion-card">
            <h3>üö´ Sesi√≥n en uso</h3>
            <p>Se ha detectado que alguien m√°s ingres√≥ a tu cuenta desde otro dispositivo.</p>
            <div class="aviso-importante">
              ‚ö†Ô∏è <strong>Recuerda:</strong> Por seguridad, el acceso est√° permitido a <b>un solo dispositivo a la vez</b>.
            </div>
            <p style="margin-top:20px; font-size:1.1rem; color:#fff;">
              Cerrando sesi√≥n en <span id="segundos-restantes" style="font-weight:bold; color:#e63946; font-size:1.5rem;">10</span> segundos...
            </p>
          </div>
        `;
        
        const intervalo = setInterval(() => {
          cuentaRegresiva--;
          const spanSegundos = document.getElementById("segundos-restantes");
          if (spanSegundos) spanSegundos.innerText = cuentaRegresiva;

          if (cuentaRegresiva <= 0) {
            clearInterval(intervalo);
            ejecutarSalida();
          }
        }, 1000);

        async function ejecutarSalida() {
          await signOut(auth); 
          window.location.href = "index.html";
        }
      }
    });
  });

  if (huayno.videoId) {
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    window.onYouTubeIframeAPIReady = function() {
      window.player = new YT.Player('player', {
        videoId: huayno.videoId,
        playerVars: { 'start': huayno.inicio, 'controls': 0, 'modestbranding': 1, 'rel': 0, 'iv_load_policy': 3, 'disablekb': 1, 'playsinline': 1 }
      });
    };
  } else {
    document.getElementById("player").innerHTML = `<div style="padding-top:20%; color:#888;">Video no disponible a√∫n üé∫</div>`;
  }

  window.globalLogout = async () => { await signOut(auth); window.location.href = "index.html"; };
</script>

<script>
  function togglePlay() {
    if (!window.player || typeof player.getPlayerState !== 'function') return;
    if (player.getPlayerState() == 1) player.pauseVideo();
    else player.playVideo();
  }
  function seek(s) { 
    if (!window.player || typeof player.getCurrentTime !== 'function') return;
    player.seekTo(player.getCurrentTime() + s, true); 
  }
  function irAlInicio() { 
    if (!window.player || typeof player.seekTo !== 'function') return;
    player.seekTo(window.inicioActual, true); 
    player.playVideo(); 
  }
</script>
</body>
</html>