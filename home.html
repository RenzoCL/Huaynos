<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biblioteca - Huaynos </title>
  <style>
    :root { --lam: #ff4d4d; --mim: #4dff88; --rem: #4d94ff; --solm: #ffcc4d; }
    body { font-family: 'Segoe UI', sans-serif; background: #111; color: white; margin: 0; text-align: center; }
    
    /* Navbar */
    nav { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #1a1a1a; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 1000; }
    .btn-nav { text-decoration: none; font-weight: bold; font-size: 0.85rem; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; }
    .btn-inicio { background: #444; color: white; }
    .btn-logout { background: #e63946; color: white; }

    .buscador { width: 90%; max-width: 400px; padding: 12px; border-radius: 25px; border: 1px solid #444; margin: 20px auto; background: #222; color: white; display: block; }
    
    .grid-huaynos { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; max-width: 1000px; margin: auto; padding: 0 15px 40px; }

    .card { background: #1a1a1a; border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.2s; border-bottom: 4px solid #444; text-decoration: none; color: white; display: flex; flex-direction: column; height: 85px; justify-content: center; }
    .card:hover { transform: scale(1.03); background: #252525; }

    /* Colores por tono */
    .la-menor { border-color: var(--lam); } .mi-menor { border-color: var(--mim); }
    .re-menor { border-color: var(--rem); } .sol-menor { border-color: var(--solm); }
    .tono-tag { font-size: 0.65em; font-weight: bold; margin-bottom: 5px; opacity: 0.8; text-transform: uppercase; }
    .titulo { font-size: 0.85em; font-weight: 600; line-height: 1.2; }

    .expulsion-card { background: #3a1a1a; border: 2px solid #e63946; padding: 30px; border-radius: 15px; margin: 20px; }
  </style>
</head>
<body>

<nav>
  <a href="home.html" class="btn-nav btn-inicio"> Inicio</a>
  <button onclick="globalLogout()" class="btn-nav btn-logout">Cerrar Sesi贸n</button>
</nav>

<h2 style="margin-top:20px;">Mi Repertorio </h2>
<input type="text" id="buscador" class="buscador" placeholder=" Buscar huayno o tono...">

<div id="main-content">
  <div class="grid-huaynos" id="lista"></div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const listaDiv = document.getElementById("lista");
  const mainContent = document.getElementById("main-content");
  const buscador = document.getElementById("buscador");

  let deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
  localStorage.setItem("deviceId", deviceId);
  let expulsando = false;

  const huaynos = [
    { id: 1, titulo: "Ayer la vi a mi ex", tono: "La menor", clase: "la-menor" },
    { id: 2, titulo: "Brindar茅 Por Ti", tono: "La menor", clase: "la-menor" },
    { id: 3, titulo: "Cajamarquina", tono: "La menor", clase: "la-menor" },
    { id: 4, titulo: "Cancer de Amor", tono: "La menor", clase: "la-menor" },
    { id: 5, titulo: "Chico Mentiroso", tono: "La menor", clase: "la-menor" },
    { id: 6, titulo: "Choferito Carretero", tono: "La menor", clase: "la-menor" },
    { id: 7, titulo: "Collar de Lagrimas", tono: "La menor", clase: "la-menor" },
    { id: 8, titulo: "Don Mario", tono: "La menor", clase: "la-menor" },
    { id: 9, titulo: "Dos Mas Por Favor", tono: "La menor", clase: "la-menor" },
    { id: 10, titulo: "En Soledad", tono: "La menor", clase: "la-menor" },
    { id: 11, titulo: "Hualaycho Bandido", tono: "La menor", clase: "la-menor" },
    { id: 12, titulo: "Madre", tono: "La menor", clase: "la-menor" },
    { id: 13, titulo: "Mala Tu", tono: "La menor", clase: "la-menor" },
    { id: 14, titulo: "Me Marchar茅", tono: "La menor", clase: "la-menor" },
    { id: 15, titulo: "Mi Barrio La Soledad", tono: "La menor", clase: "la-menor" },
    { id: 16, titulo: "Mix Flor Pile帽a", tono: "La menor", clase: "la-menor" },
    { id: 17, titulo: "No Se Puede Morir de Amor", tono: "La menor", clase: "la-menor" },
    { id: 18, titulo: "Otra Vez Me Enamor茅", tono: "La menor", clase: "la-menor" },
    { id: 19, titulo: "Pocos Minutos", tono: "La menor", clase: "la-menor" },
    { id: 20, titulo: "Por el Chiquito", tono: "La menor", clase: "la-menor" },
    { id: 21, titulo: "Que Se Vaya", tono: "La menor", clase: "la-menor" },
    { id: 22, titulo: "Tienes Tu Due帽o", tono: "La menor", clase: "la-menor" },
    { id: 23, titulo: "Tomo Con Mi Plata", tono: "La menor", clase: "la-menor" },
    { id: 24, titulo: "Viaje de Amor", tono: "La menor", clase: "la-menor" },
    { id: 25, titulo: "Vizcachita", tono: "La menor", clase: "la-menor" },
    { id: 26, titulo: "A Los Filos De Un Cuchillo", tono: "Mi menor", clase: "mi-menor" },
    { id: 27, titulo: "Busco un Amor", tono: "Mi menor", clase: "mi-menor" },
    { id: 28, titulo: "Dejame", tono: "Mi menor", clase: "mi-menor" },
    { id: 29, titulo: "Dos Cervezas Mas", tono: "Mi menor", clase: "mi-menor" },
    { id: 30, titulo: "El Amor de mi Vida", tono: "Mi menor", clase: "mi-menor" },
    { id: 31, titulo: "Hay Niveles", tono: "Mi menor", clase: "mi-menor" },
    { id: 32, titulo: "La Cadena Se Rompi贸", tono: "Mi menor", clase: "mi-menor" },
    { id: 33, titulo: "Linda Andahuaylina", tono: "Mi menor", clase: "mi-menor" },
    { id: 34, titulo: "Linda Huaracina", tono: "Mi menor", clase: "mi-menor" },
    { id: 35, titulo: "Mujer Carhuacina", tono: "Mi menor", clase: "mi-menor" },
    { id: 36, titulo: "Pajaro Pajaro Pajaro", tono: "Mi menor", clase: "mi-menor" },
    { id: 37, titulo: "Perdoname", tono: "Mi menor", clase: "mi-menor" },
    { id: 38, titulo: "Por Que Me Dices Que Te Vas", tono: "Mi menor", clase: "mi-menor" },
    { id: 39, titulo: "Puente de Marcar谩", tono: "Mi menor", clase: "mi-menor" },
    { id: 40, titulo: "Que Linda Flor", tono: "Mi menor", clase: "mi-menor" },
    { id: 41, titulo: "Rio Santa", tono: "Mi menor", clase: "mi-menor" },
    { id: 42, titulo: "Rosaura Lindaura", tono: "Mi menor", clase: "mi-menor" },
    { id: 43, titulo: "Tomar茅 Para Olvidarte", tono: "Mi menor", clase: "mi-menor" },
    { id: 44, titulo: "Un Domingo Yo La Vi", tono: "Mi menor", clase: "mi-menor" },
    { id: 45, titulo: "Valicha", tono: "Mi menor", clase: "mi-menor" },
    { id: 46, titulo: "Yo Nac铆 Solo Para Ti", tono: "Mi menor", clase: "mi-menor" },
    { id: 47, titulo: "Abreme La Puerta", tono: "Re menor", clase: "re-menor" },
    { id: 48, titulo: "Amor Por Internet", tono: "Re menor", clase: "re-menor" },
    { id: 49, titulo: "Cajamarquina", tono: "Re menor", clase: "re-menor" },
    { id: 50, titulo: "Capitalina", tono: "Re menor", clase: "re-menor" },
    { id: 51, titulo: "Como Duele el Coraz贸n", tono: "Re menor", clase: "re-menor" },
    { id: 52, titulo: "El Coche de su Madre", tono: "Re menor", clase: "re-menor" },
    { id: 53, titulo: "La Proforma", tono: "Re menor", clase: "re-menor" },
    { id: 54, titulo: "Lloro Por Tu Amor", tono: "Re menor", clase: "re-menor" },
    { id: 55, titulo: "Marchate", tono: "Re menor", clase: "re-menor" },
    { id: 56, titulo: "Me Estas Sacando La Vuelta", tono: "Re menor", clase: "re-menor" },
    { id: 57, titulo: "Mujer Carhuacina", tono: "Re menor", clase: "re-menor" },
    { id: 58, titulo: "No Me Preguntes Por Ella", tono: "Re menor", clase: "re-menor" },
    { id: 59, titulo: "Pasame La Cerveza", tono: "Re menor", clase: "re-menor" },
    { id: 60, titulo: "Por Ti", tono: "Re menor", clase: "re-menor" },
    { id: 61, titulo: "Soledad", tono: "Re menor", clase: "re-menor" },
    { id: 62, titulo: "Todo Empez贸 Como Jugando", tono: "Re menor", clase: "re-menor" },
    { id: 63, titulo: "Un Domingo Yo La Vi", tono: "Re menor", clase: "re-menor" },
    { id: 64, titulo: "Amigo", tono: "Sol menor", clase: "sol-menor" },
    { id: 65, titulo: "Aquella Tarde", tono: "Sol menor", clase: "sol-menor" },
    { id: 66, titulo: "Brindar茅 Por Ti", tono: "Sol menor", clase: "sol-menor" },
    { id: 67, titulo: "Chofercito Carretero", tono: "Sol menor", clase: "sol-menor" },
    { id: 68, titulo: "Don Mario", tono: "Sol menor", clase: "sol-menor" },
    { id: 69, titulo: "Hay Niveles", tono: "Sol menor", clase: "sol-menor" },
    { id: 70, titulo: "La Cadena Se Rompi贸", tono: "Sol menor", clase: "sol-menor" },
    { id: 71, titulo: "La Chismosa", tono: "Sol menor", clase: "sol-menor" },
    { id: 72, titulo: "Madre", tono: "Sol menor", clase: "sol-menor" },
    { id: 73, titulo: "Mary se Llama", tono: "Sol menor", clase: "sol-menor" },
    { id: 74, titulo: "Me Emborracho Por Tu Amor", tono: "Sol menor", clase: "sol-menor" },
    { id: 75, titulo: "Mix Flor Pi帽a", tono: "Sol menor", clase: "sol-menor" },
    { id: 76, titulo: "No Puedo Amarte", tono: "Sol menor", clase: "sol-menor" },
    { id: 77, titulo: "Otra Vez Me Enamor茅", tono: "Sol menor", clase: "sol-menor" },
    { id: 78, titulo: "Que Linda Flor", tono: "Sol menor", clase: "sol-menor" },
    { id: 79, titulo: "Viaje de Amor", tono: "Sol menor", clase: "sol-menor" },
    { id: 80, titulo: "Vizcachita", tono: "Sol menor", clase: "sol-menor" },
    { id: 81, titulo: "Ya Se March贸", tono: "Sol menor", clase: "sol-menor" }
  ];

  onAuthStateChanged(auth, async (user) => {
    if (!user && !expulsando) { window.location.href = "index.html"; return; }
    if (!user) return;
    const sessionRef = doc(db, "sessions", user.uid);
    await setDoc(sessionRef, { devices: [deviceId] }, { merge: false });
    onSnapshot(sessionRef, (snap) => {
      if (!expulsando && snap.exists() && !snap.data().devices.includes(deviceId)) ejecutarExpulsion();
    });
  });

  function ejecutarExpulsion() {
    expulsando = true;
    mainContent.innerHTML = `<div class="expulsion-card"><h3> Sesi贸n ocupada</h3><p id="countdown">Saliendo en 5 segundos...</p></div>`;
    let seg = 5;
    const t = setInterval(async () => {
      seg--;
      if(document.getElementById("countdown")) document.getElementById("countdown").innerText = `Saliendo en ${seg} segundos...`;
      if (seg <= 0) { clearInterval(t); await signOut(auth); window.location.href = "index.html"; }
    }, 1000);
  }

  function render(filtro = "") {
    listaDiv.innerHTML = "";
    const filtrados = huaynos.filter(h => h.titulo.toLowerCase().includes(filtro.toLowerCase()) || h.tono.toLowerCase().includes(filtro.toLowerCase()));
    filtrados.forEach(h => {
      const card = document.createElement("a");
      card.href = `huayno.html?id=${h.id}`;
      card.className = `card ${h.clase}`;
      card.innerHTML = `<span class="tono-tag">${h.tono}</span><span class="titulo">${h.titulo}</span>`;
      listaDiv.appendChild(card);
    });
  }

  buscador.addEventListener("input", (e) => render(e.target.value));
  render();

  window.globalLogout = async () => { expulsando = true; await signOut(auth); window.location.href = "index.html"; };
</script>
</body>
</html>