<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca - Huaynos </title>
    <link rel="stylesheet" href="estilos.css?v=1.0.2">
    <style>
        :root { --lam: #ff4d4d; --mim: #4dff88; --rem: #4d94ff; --solm: #ffcc4d; }
        .buscador { width: 90%; max-width: 400px; padding: 12px; border-radius: 25px; border: 1px solid #444; margin: 20px auto; background: #222; color: white; display: block; }
        .grid-huaynos { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; max-width: 1000px; margin: auto; padding: 0 15px 40px; }
        .card { background: #1a1a1a; border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.2s; border-bottom: 4px solid #444; text-decoration: none; color: white; display: flex; flex-direction: column; height: 85px; justify-content: center; }
        .card:hover { transform: scale(1.03); background: #252525; }
        /* Clases de colores para las tarjetas */
        .la-menor { border-color: var(--lam); } .mi-menor { border-color: var(--mim); }
        .re-menor { border-color: var(--rem); } .sol-menor { border-color: var(--solm); }
        .tono-tag { font-size: 0.65em; font-weight: bold; margin-bottom: 5px; opacity: 0.8; text-transform: uppercase; }
        .titulo { font-size: 0.85em; font-weight: 600; line-height: 1.2; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div style="position: fixed; top: 10px; right: 10px; font-size: 0.7rem; color: #555; z-index: 9999; font-family: monospace;">
        v1.0.2
    </div>

    <nav>
        <a href="home.html" class="btn-nav btn-inicio"> Inicio</a>
        <button id="btnLogOut" class="btn-nav btn-logout">Cerrar Sesi贸n</button>
    </nav>

    <h2 style="margin-top:20px;">Mi Repertorio </h2>
    <input type="text" id="buscador" class="buscador" placeholder=" Buscar huayno o tono...">

    <div id="main-content">
        <div class="grid-huaynos" id="lista"></div>
    </div>

    <script type="module">
        import { auth, db } from "./firebase.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // IMPORTACIONES MODULARES (A帽adimos versi贸n para saltar cach茅)
        import { baseDeHuaynos } from "./huaynos.js?v=1.0.2";
        import { manejarExpulsion, globalLogout } from "./seguridad.js?v=1.0.2";

        const listaDiv = document.getElementById("lista");
        const mainContent = document.getElementById("main-content");
        const buscador = document.getElementById("buscador");

        let deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
        localStorage.setItem("deviceId", deviceId);
        let expulsando = false;

        // Configurar bot贸n de cerrar sesi贸n
        document.getElementById("btnLogOut").onclick = () => {
            expulsando = true;
            globalLogout(auth);
        };

        onAuthStateChanged(auth, async (user) => {
            if (!user && !expulsando) { window.location.href = "index.html"; return; }
            if (!user) return;

            const sessionRef = doc(db, "sessions", user.uid);
            await setDoc(sessionRef, { devices: [deviceId] }, { merge: false });

            onSnapshot(sessionRef, (snap) => {
                if (snap.metadata.hasPendingWrites) return;
                if (!expulsando && snap.exists() && !snap.data().devices.includes(deviceId)) {
                    expulsando = true;
                    manejarExpulsion(mainContent, auth);
                }
            });
        });

        // Funci贸n para dibujar las tarjetas (usa la base de datos importada)
        function render(filtro = "") {
            listaDiv.innerHTML = "";
            
            // Convertimos el objeto de huaynos en un array para poder filtrarlo
            const arrayHuaynos = Object.keys(baseDeHuaynos).map(id => ({ id, ...baseDeHuaynos[id] }));

            const filtrados = arrayHuaynos.filter(h => 
                h.titulo.toLowerCase().includes(filtro.toLowerCase()) || 
                h.tonalidad.toLowerCase().includes(filtro.toLowerCase())
            );

            filtrados.forEach(h => {
                const card = document.createElement("a");
                card.href = `huayno.html?id=${h.id}`;
                
                // Asignar clase de color seg煤n tono
                let claseColor = "la-menor";
                if(h.tonalidad.includes("Mi menor")) claseColor = "mi-menor";
                if(h.tonalidad.includes("Re menor")) claseColor = "re-menor";
                if(h.tonalidad.includes("Sol menor")) claseColor = "sol-menor";

                card.className = `card ${claseColor}`;
                card.innerHTML = `<span class="tono-tag">${h.tonalidad}</span><span class="titulo">${h.titulo}</span>`;
                listaDiv.appendChild(card);
            });
        }

        buscador.addEventListener("input", (e) => render(e.target.value));
        render(); // Carga inicial
    </script>
</body>
</html>